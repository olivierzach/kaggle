# kaggle: housing prices prediction
# predict housing prices based on list of features
# https://stats.stackexchange.com/questions/95083/imputation-before-or-after-splitting-into-train-and-test

# workflow: 
#  load data > split training data > pre-process > explore > visualize > model:
#  apply to validation > iterate : apply to final test



# packages ----------------------------------------------------------------

library(tidyverse); library(caret); library(GGally);library(corrplot)
library(ggcorrplot); library(ggthemes)


# load data --------------------------------------------------------------

# test data set
test <- read_csv("test.csv")

str(test); dim(test)
# Classes ‘tbl_df’, ‘tbl’ and 'data.frame':	1459 obs. of  80 variables:
# $ Id           : int  1461 1462 1463 1464 1465 1466 1467 1468 1469 1470 ...
# $ MSSubClass   : int  20 20 60 60 120 60 20 60 20 20 ...
# $ MSZoning     : chr  "RH" "RL" "RL" "RL" ...
# $ LotFrontage  : int  80 81 74 78 43 75 NA 63 85 70 ...
# $ LotArea      : int  11622 14267 13830 9978 5005 10000 7980 8402 10176 8400 ...
# $ Street       : chr  "Pave" "Pave" "Pave" "Pave" ...
# $ Alley        : chr  NA NA NA NA ...
# $ LotShape     : chr  "Reg" "IR1" "IR1" "IR1" ...
# $ LandContour  : chr  "Lvl" "Lvl" "Lvl" "Lvl" ...
# $ Utilities    : chr  "AllPub" "AllPub" "AllPub" "AllPub" ...
# $ LotConfig    : chr  "Inside" "Corner" "Inside" "Inside" ...
# $ LandSlope    : chr  "Gtl" "Gtl" "Gtl" "Gtl" ...
# $ Neighborhood : chr  "NAmes" "NAmes" "Gilbert" "Gilbert" ...
# $ Condition1   : chr  "Feedr" "Norm" "Norm" "Norm" ...
# $ Condition2   : chr  "Norm" "Norm" "Norm" "Norm" ...
# $ BldgType     : chr  "1Fam" "1Fam" "1Fam" "1Fam" ...
# $ HouseStyle   : chr  "1Story" "1Story" "2Story" "2Story" ...
# $ OverallQual  : int  5 6 5 6 8 6 6 6 7 4 ...
# $ OverallCond  : int  6 6 5 6 5 5 7 5 5 5 ...
# $ YearBuilt    : int  1961 1958 1997 1998 1992 1993 1992 1998 1990 1970 ...
# $ YearRemodAdd : int  1961 1958 1998 1998 1992 1994 2007 1998 1990 1970 ...
# $ RoofStyle    : chr  "Gable" "Hip" "Gable" "Gable" ...
# $ RoofMatl     : chr  "CompShg" "CompShg" "CompShg" "CompShg" ...
# $ Exterior1st  : chr  "VinylSd" "Wd Sdng" "VinylSd" "VinylSd" ...
# $ Exterior2nd  : chr  "VinylSd" "Wd Sdng" "VinylSd" "VinylSd" ...
# $ MasVnrType   : chr  "None" "BrkFace" "None" "BrkFace" ...
# $ MasVnrArea   : int  0 108 0 20 0 0 0 0 0 0 ...
# $ ExterQual    : chr  "TA" "TA" "TA" "TA" ...
# $ ExterCond    : chr  "TA" "TA" "TA" "TA" ...
# $ Foundation   : chr  "CBlock" "CBlock" "PConc" "PConc" ...
# $ BsmtQual     : chr  "TA" "TA" "Gd" "TA" ...
# $ BsmtCond     : chr  "TA" "TA" "TA" "TA" ...
# $ BsmtExposure : chr  "No" "No" "No" "No" ...
# $ BsmtFinType1 : chr  "Rec" "ALQ" "GLQ" "GLQ" ...
# $ BsmtFinSF1   : int  468 923 791 602 263 0 935 0 637 804 ...
# $ BsmtFinType2 : chr  "LwQ" "Unf" "Unf" "Unf" ...
# $ BsmtFinSF2   : int  144 0 0 0 0 0 0 0 0 78 ...
# $ BsmtUnfSF    : int  270 406 137 324 1017 763 233 789 663 0 ...
# $ TotalBsmtSF  : int  882 1329 928 926 1280 763 1168 789 1300 882 ...
# $ Heating      : chr  "GasA" "GasA" "GasA" "GasA" ...
# $ HeatingQC    : chr  "TA" "TA" "Gd" "Ex" ...
# $ CentralAir   : chr  "Y" "Y" "Y" "Y" ...
# $ Electrical   : chr  "SBrkr" "SBrkr" "SBrkr" "SBrkr" ...
# $ 1stFlrSF     : int  896 1329 928 926 1280 763 1187 789 1341 882 ...
# $ 2ndFlrSF     : int  0 0 701 678 0 892 0 676 0 0 ...
# $ LowQualFinSF : int  0 0 0 0 0 0 0 0 0 0 ...
# $ GrLivArea    : int  896 1329 1629 1604 1280 1655 1187 1465 1341 882 ...
# $ BsmtFullBath : int  0 0 0 0 0 0 1 0 1 1 ...
# $ BsmtHalfBath : int  0 0 0 0 0 0 0 0 0 0 ...
# $ FullBath     : int  1 1 2 2 2 2 2 2 1 1 ...
# $ HalfBath     : int  0 1 1 1 0 1 0 1 1 0 ...
# $ BedroomAbvGr : int  2 3 3 3 2 3 3 3 2 2 ...
# $ KitchenAbvGr : int  1 1 1 1 1 1 1 1 1 1 ...
# $ KitchenQual  : chr  "TA" "Gd" "TA" "Gd" ...
# $ TotRmsAbvGrd : int  5 6 6 7 5 7 6 7 5 4 ...
# $ Functional   : chr  "Typ" "Typ" "Typ" "Typ" ...
# $ Fireplaces   : int  0 0 1 1 0 1 0 1 1 0 ...
# $ FireplaceQu  : chr  NA NA "TA" "Gd" ...
# $ GarageType   : chr  "Attchd" "Attchd" "Attchd" "Attchd" ...
# $ GarageYrBlt  : int  1961 1958 1997 1998 1992 1993 1992 1998 1990 1970 ...
# $ GarageFinish : chr  "Unf" "Unf" "Fin" "Fin" ...
# $ GarageCars   : int  1 1 2 2 2 2 2 2 2 2 ...
# $ GarageArea   : int  730 312 482 470 506 440 420 393 506 525 ...
# $ GarageQual   : chr  "TA" "TA" "TA" "TA" ...
# $ GarageCond   : chr  "TA" "TA" "TA" "TA" ...
# $ PavedDrive   : chr  "Y" "Y" "Y" "Y" ...
# $ WoodDeckSF   : int  140 393 212 360 0 157 483 0 192 240 ...
# $ OpenPorchSF  : int  0 36 34 36 82 84 21 75 0 0 ...
# $ EnclosedPorch: int  0 0 0 0 0 0 0 0 0 0 ...
# $ 3SsnPorch    : int  0 0 0 0 0 0 0 0 0 0 ...
# $ ScreenPorch  : int  120 0 0 0 144 0 0 0 0 0 ...
# $ PoolArea     : int  0 0 0 0 0 0 0 0 0 0 ...
# $ PoolQC       : chr  NA NA NA NA ...
# $ Fence        : chr  "MnPrv" NA "MnPrv" NA ...
# $ MiscFeature  : chr  NA "Gar2" NA NA ...
# $ MiscVal      : int  0 12500 0 0 0 0 500 0 0 0 ...
# $ MoSold       : int  6 6 3 6 1 4 3 5 2 4 ...
# $ YrSold       : int  2010 2010 2010 2010 2010 2010 2010 2010 2010 2010 ...
# $ SaleType     : chr  "WD" "WD" "WD" "WD" ...
# $ SaleCondition: chr  "Normal" "Normal" "Normal" "Normal" ...

# training data set
train <- read_csv("train.csv")

str(train);dim(train)
# Classes ‘tbl_df’, ‘tbl’ and 'data.frame':	1460 obs. of  81 variables:
#         $ Id           : int  1 2 3 4 5 6 7 8 9 10 ...
# $ MSSubClass   : int  60 20 60 70 60 50 20 60 50 190 ...
# $ MSZoning     : chr  "RL" "RL" "RL" "RL" ...
# $ LotFrontage  : int  65 80 68 60 84 85 75 NA 51 50 ...
# $ LotArea      : int  8450 9600 11250 9550 14260 14115 10084 10382 6120 7420 ...
# $ Street       : chr  "Pave" "Pave" "Pave" "Pave" ...
# $ Alley        : chr  NA NA NA NA ...
# $ LotShape     : chr  "Reg" "Reg" "IR1" "IR1" ...
# $ LandContour  : chr  "Lvl" "Lvl" "Lvl" "Lvl" ...
# $ Utilities    : chr  "AllPub" "AllPub" "AllPub" "AllPub" ...
# $ LotConfig    : chr  "Inside" "FR2" "Inside" "Corner" ...
# $ LandSlope    : chr  "Gtl" "Gtl" "Gtl" "Gtl" ...
# $ Neighborhood : chr  "CollgCr" "Veenker" "CollgCr" "Crawfor" ...
# $ Condition1   : chr  "Norm" "Feedr" "Norm" "Norm" ...
# $ Condition2   : chr  "Norm" "Norm" "Norm" "Norm" ...
# $ BldgType     : chr  "1Fam" "1Fam" "1Fam" "1Fam" ...
# $ HouseStyle   : chr  "2Story" "1Story" "2Story" "2Story" ...
# $ OverallQual  : int  7 6 7 7 8 5 8 7 7 5 ...
# $ OverallCond  : int  5 8 5 5 5 5 5 6 5 6 ...
# $ YearBuilt    : int  2003 1976 2001 1915 2000 1993 2004 1973 1931 1939 ...
# $ YearRemodAdd : int  2003 1976 2002 1970 2000 1995 2005 1973 1950 1950 ...
# $ RoofStyle    : chr  "Gable" "Gable" "Gable" "Gable" ...
# $ RoofMatl     : chr  "CompShg" "CompShg" "CompShg" "CompShg" ...
# $ Exterior1st  : chr  "VinylSd" "MetalSd" "VinylSd" "Wd Sdng" ...
# $ Exterior2nd  : chr  "VinylSd" "MetalSd" "VinylSd" "Wd Shng" ...
# $ MasVnrType   : chr  "BrkFace" "None" "BrkFace" "None" ...
# $ MasVnrArea   : int  196 0 162 0 350 0 186 240 0 0 ...
# $ ExterQual    : chr  "Gd" "TA" "Gd" "TA" ...
# $ ExterCond    : chr  "TA" "TA" "TA" "TA" ...
# $ Foundation   : chr  "PConc" "CBlock" "PConc" "BrkTil" ...
# $ BsmtQual     : chr  "Gd" "Gd" "Gd" "TA" ...
# $ BsmtCond     : chr  "TA" "TA" "TA" "Gd" ...
# $ BsmtExposure : chr  "No" "Gd" "Mn" "No" ...
# $ BsmtFinType1 : chr  "GLQ" "ALQ" "GLQ" "ALQ" ...
# $ BsmtFinSF1   : int  706 978 486 216 655 732 1369 859 0 851 ...
# $ BsmtFinType2 : chr  "Unf" "Unf" "Unf" "Unf" ...
# $ BsmtFinSF2   : int  0 0 0 0 0 0 0 32 0 0 ...
# $ BsmtUnfSF    : int  150 284 434 540 490 64 317 216 952 140 ...
# $ TotalBsmtSF  : int  856 1262 920 756 1145 796 1686 1107 952 991 ...
# $ Heating      : chr  "GasA" "GasA" "GasA" "GasA" ...
# $ HeatingQC    : chr  "Ex" "Ex" "Ex" "Gd" ...
# $ CentralAir   : chr  "Y" "Y" "Y" "Y" ...
# $ Electrical   : chr  "SBrkr" "SBrkr" "SBrkr" "SBrkr" ...
# $ 1stFlrSF     : int  856 1262 920 961 1145 796 1694 1107 1022 1077 ...
# $ 2ndFlrSF     : int  854 0 866 756 1053 566 0 983 752 0 ...
# $ LowQualFinSF : int  0 0 0 0 0 0 0 0 0 0 ...
# $ GrLivArea    : int  1710 1262 1786 1717 2198 1362 1694 2090 1774 1077 ...
# $ BsmtFullBath : int  1 0 1 1 1 1 1 1 0 1 ...
# $ BsmtHalfBath : int  0 1 0 0 0 0 0 0 0 0 ...
# $ FullBath     : int  2 2 2 1 2 1 2 2 2 1 ...
# $ HalfBath     : int  1 0 1 0 1 1 0 1 0 0 ...
# $ BedroomAbvGr : int  3 3 3 3 4 1 3 3 2 2 ...
# $ KitchenAbvGr : int  1 1 1 1 1 1 1 1 2 2 ...
# $ KitchenQual  : chr  "Gd" "TA" "Gd" "Gd" ...
# $ TotRmsAbvGrd : int  8 6 6 7 9 5 7 7 8 5 ...
# $ Functional   : chr  "Typ" "Typ" "Typ" "Typ" ...
# $ Fireplaces   : int  0 1 1 1 1 0 1 2 2 2 ...
# $ FireplaceQu  : chr  NA "TA" "TA" "Gd" ...
# $ GarageType   : chr  "Attchd" "Attchd" "Attchd" "Detchd" ...
# $ GarageYrBlt  : int  2003 1976 2001 1998 2000 1993 2004 1973 1931 1939 ...
# $ GarageFinish : chr  "RFn" "RFn" "RFn" "Unf" ...
# $ GarageCars   : int  2 2 2 3 3 2 2 2 2 1 ...
# $ GarageArea   : int  548 460 608 642 836 480 636 484 468 205 ...
# $ GarageQual   : chr  "TA" "TA" "TA" "TA" ...
# $ GarageCond   : chr  "TA" "TA" "TA" "TA" ...
# $ PavedDrive   : chr  "Y" "Y" "Y" "Y" ...
# $ WoodDeckSF   : int  0 298 0 0 192 40 255 235 90 0 ...
# $ OpenPorchSF  : int  61 0 42 35 84 30 57 204 0 4 ...
# $ EnclosedPorch: int  0 0 0 272 0 0 0 228 205 0 ...
# $ 3SsnPorch    : int  0 0 0 0 0 320 0 0 0 0 ...
# $ ScreenPorch  : int  0 0 0 0 0 0 0 0 0 0 ...
# $ PoolArea     : int  0 0 0 0 0 0 0 0 0 0 ...
# $ PoolQC       : chr  NA NA NA NA ...
# $ Fence        : chr  NA NA NA NA ...
# $ MiscFeature  : chr  NA NA NA NA ...
# $ MiscVal      : int  0 0 0 0 0 700 0 350 0 0 ...
# $ MoSold       : int  2 5 9 2 12 10 8 11 4 1 ...
# $ YrSold       : int  2008 2007 2008 2006 2008 2009 2007 2009 2008 2008 ...
# $ SaleType     : chr  "WD" "WD" "WD" "WD" ...
# $ SaleCondition: chr  "Normal" "Normal" "Normal" "Abnorml" ...
# $ SalePrice    : int  208500 181500 223500 140000 250000 143000 307000 200000 129900 118000 ...


# missing variables?
# SalePrice not found in test data set
# will need to create a validation set in our complete training only
setdiff(names(train), names(test))
# [1] "SalePrice"


# workflow: build model in train > apply to validation > apply to test for final prediction

# build new training and new validation set
# we will use train.df to build our model
# we can use valid.df to guage testing estimate performance
# https://topepo.github.io/caret/data-splitting.html
set.seed(456)

# create subset
inTrain <- createDataPartition(train$SalePrice, p = .7, list = F)

# new training and validation sets
train.df <- train[inTrain,]
valid.df <- train[-inTrain,]

dim(train.df)
# [1] 1024   81

dim(valid.df)
# [1] 436  81





# explore -----------------------------------------------------------------

## column classes

# we have a mix of numeric and character variables
# we will need a combined method to identify correlation between each predictor
# possible: significance tests vs. effect size?
# ANOVA?
# covert all to factors? factors will assume the scale is "uniform" for each level of factor!
# https://stats.stackexchange.com/questions/119835/correlation-between-a-nominal-iv-and-a-continuous-dv-variable/124618#124618
class.train <- sapply(train.df, class) %>% 
        as.data.frame() %>% 
        rownames_to_column('variable') %>% 
        plyr::rename(c("." = "class"))

# half of our variables are categorical
sum(class.train$class == "character") / nrow(class.train)
# [1] 0.5308642

class.train %>% filter(class == "character")
#         variable     class
# 1       MSZoning character
# 2         Street character
# 3          Alley character
# 4       LotShape character
# 5    LandContour character
# 6      Utilities character
# 7      LotConfig character
# 8      LandSlope character
# 9   Neighborhood character
# 10    Condition1 character
# 11    Condition2 character
# 12      BldgType character
# 13    HouseStyle character
# 14     RoofStyle character
# 15      RoofMatl character
# 16   Exterior1st character
# 17   Exterior2nd character
# 18    MasVnrType character
# 19     ExterQual character
# 20     ExterCond character
# 21    Foundation character
# 22      BsmtQual character
# 23      BsmtCond character
# 24  BsmtExposure character
# 25  BsmtFinType1 character
# 26  BsmtFinType2 character
# 27       Heating character
# 28     HeatingQC character
# 29    CentralAir character
# 30    Electrical character
# 31   KitchenQual character
# 32    Functional character
# 33   FireplaceQu character
# 34    GarageType character
# 35  GarageFinish character
# 36    GarageQual character
# 37    GarageCond character
# 38    PavedDrive character
# 39        PoolQC character
# 40         Fence character
# 41   MiscFeature character
# 42      SaleType character
# 43 SaleCondition character

class.train %>% filter(class == "integer")
#         variable   class
# 1             Id integer
# 2     MSSubClass integer
# 3    LotFrontage integer
# 4        LotArea integer
# 5    OverallQual integer
# 6    OverallCond integer
# 7      YearBuilt integer
# 8   YearRemodAdd integer
# 9     MasVnrArea integer
# 10    BsmtFinSF1 integer
# 11    BsmtFinSF2 integer
# 12     BsmtUnfSF integer
# 13   TotalBsmtSF integer
# 14      1stFlrSF integer
# 15      2ndFlrSF integer
# 16  LowQualFinSF integer
# 17     GrLivArea integer
# 18  BsmtFullBath integer
# 19  BsmtHalfBath integer
# 20      FullBath integer
# 21      HalfBath integer
# 22  BedroomAbvGr integer
# 23  KitchenAbvGr integer
# 24  TotRmsAbvGrd integer
# 25    Fireplaces integer
# 26   GarageYrBlt integer
# 27    GarageCars integer
# 28    GarageArea integer
# 29    WoodDeckSF integer
# 30   OpenPorchSF integer
# 31 EnclosedPorch integer
# 32     3SsnPorch integer
# 33   ScreenPorch integer
# 34      PoolArea integer
# 35       MiscVal integer
# 36        MoSold integer
# 37        YrSold integer
# 38     SalePrice integer











## missing values

# which columns have missing data?
(missing.train <- colMeans(is.na(train.df)) %>% 
        as.data.frame() %>% 
        rownames_to_column('variable') %>% 
        plyr::rename(c("." = "perc_missing")) %>% 
        filter(perc_missing > 0) %>% 
        arrange(-perc_missing))

#         variable perc_missing
# 1        PoolQC 0.9960937500
# 2   MiscFeature 0.9619140625
# 3         Alley 0.9375000000
# 4         Fence 0.8105468750
# 5   FireplaceQu 0.4794921875
# 6   LotFrontage 0.1738281250
# 7    GarageType 0.0576171875
# 8   GarageYrBlt 0.0576171875
# 9  GarageFinish 0.0576171875
# 10   GarageQual 0.0576171875
# 11   GarageCond 0.0576171875
# 12 BsmtExposure 0.0214843750
# 13     BsmtQual 0.0205078125
# 14     BsmtCond 0.0205078125
# 15 BsmtFinType1 0.0205078125
# 16 BsmtFinType2 0.0205078125
# 17   MasVnrType 0.0058593750
# 18   MasVnrArea 0.0058593750
# 19   Electrical 0.0009765625


# how should we handle these missing values?
# option 1 - remove all
# option 2 - impute missing values
# option 3 - model missing values
# choices will affect how we validate and ultimately predict:
# steps to pre-process will need to be applied to valid and test
# model = K Nearest Neighbors imputation







## near zero variance predictors

# should we remove data that has no added information?
# idea is to remove variables that add nothing = Near Zero Variance
# https://topepo.github.io/caret/pre-processing.html#nzv

# investigate near zero variance predictors
# 20 of our 80 predictors are flagged as having near zero variance
# should we keep these in the model?
nzp.train <- nearZeroVar(train.df, saveMetrics = T) %>% 
        as.data.frame() %>% 
        rownames_to_column("variable") %>% 
        filter(nzv == TRUE)

#         variable  freqRatio percentUnique zeroVar  nzv
# 1         Street  255.00000     0.1953125   FALSE TRUE
# 2    LandContour   20.90909     0.3906250   FALSE TRUE
# 3      Utilities 1023.00000     0.1953125   FALSE TRUE
# 4      LandSlope   20.59574     0.2929688   FALSE TRUE
# 5     Condition2  169.00000     0.5859375   FALSE TRUE
# 6       RoofMatl  168.00000     0.4882812   FALSE TRUE
# 7       BsmtCond   22.70732     0.3906250   FALSE TRUE
# 8   BsmtFinType2   22.10000     0.5859375   FALSE TRUE
# 9        Heating   83.33333     0.4882812   FALSE TRUE
# 10  LowQualFinSF  334.33333     1.8554688   FALSE TRUE
# 11  KitchenAbvGr   22.22727     0.3906250   FALSE TRUE
# 12    Functional   41.43478     0.5859375   FALSE TRUE
# 13    GarageQual   29.64516     0.4882812   FALSE TRUE
# 14    GarageCond   42.36364     0.4882812   FALSE TRUE
# 15 EnclosedPorch   97.33333     9.5703125   FALSE TRUE
# 16     3SsnPorch  503.50000     1.6601562   FALSE TRUE
# 17   ScreenPorch  156.50000     5.6640625   FALSE TRUE
# 18      PoolArea 1020.00000     0.4882812   FALSE TRUE
# 19   MiscFeature   36.00000     0.3906250   FALSE TRUE
# 20       MiscVal   98.70000     1.4648438   FALSE TRUE


# what should we do with these varaiables that have near-zero variance?
# exclude?
# other?



## correlation
# https://stats.stackexchange.com/questions/108007/correlations-with-unordered-categorical-variables
# how do we find correlation between predictors of categorical and numeric predictors?
# most modeling techniques do not want correlated predictors!!
# first guess: ANOVA?
# how do we loop through every categorical variable and test for all levels in ANOVA?
# second guess: convert character variables
# convert all character variables to factors - then to numeric
# investigation only - if this is useful we will have to apply this step before the create data partition step!
# https://stackoverflow.com/questions/31238284/correlation-matrix-of-a-bunch-of-categorical-variables-in-r

# convert character predictors to factored numeric
cormat <- train.df %>% 
        as.data.frame() %>% 
        mutate_if(is.character, as.factor) %>% 
        mutate_if(is.factor, as.numeric) %>% 
        dplyr::select(., -Id) 
        
# correlation matrix full 
# we want to inspect predictors that are correlated with each other
cormat <- round(cor(train.dff),2) %>% 
        as.data.frame()

# correlation string for SalesPrice
# we want to include variables that are correlated with SalesPrice
cormat.sp <- round(cor(train.dff),2) %>% 
        as.data.frame() %>% 
        dplyr::select(SalePrice) %>% 
        rownames_to_column('variable') %>% 
        filter(SalePrice != "NA") %>% 
        arrange(-SalePrice) %>% 
        filter(variable != "SalePrice")


# plot the full correlation matrix
ggcorrplot(cormat, method = "circle") +
        theme(axis.text.x = element_text(angle = 90))

# plot the correlations with SalePrice
ggplot(data = cormat.sp) +
        geom_point(aes(x = reorder(variable, SalePrice), y = SalePrice, color = SalePrice)) +
        theme(axis.text.x = element_text(angle = 90)) +
        coord_flip() +
        theme_tufte() +
        geom_hline(yintercept = .5, linetype = "dotted") +
        geom_hline(yintercept = -.5, linetype = "dotted") 










